<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Buscador Inmobiliario Inteligente</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    <style>
        .card-img-top { height: 220px; object-fit: cover; }
        .busqueda-detalle .card {
            border-radius: 0.75rem;
            box-shadow: 0 2px 16px rgba(0,0,0,0.08);
            background: linear-gradient(135deg, #f8fafc 0%, #e9ecef 100%);
        }
        .busqueda-detalle h2, .busqueda-detalle h3 {
            font-weight: 700;
            color: #2c3e50;
        }
        .busqueda-detalle ul {
            padding-left: 1.2rem;
        }
        .busqueda-detalle li {
            margin-bottom: 0.5rem;
            font-size: 1.08rem;
        }
        .busqueda-detalle a.btn, .busqueda-detalle button {
            margin-top: 1rem;
        }
        .busqueda-detalle .alert-warning {
            border-radius: 0.5rem;
        }
        #filter-container {
            max-height: 1000px; /* Altura suficientemente grande para contener los filtros */
            overflow: hidden;
            transition: max-height 0.5s ease-in-out;
        }
        #filter-container.collapsed {
            max-height: 0;
        }
    </style>
</head>
<body>
    <div class="container my-4">
        <header class="text-center mb-5">
            <h1>Buscador de Propiedades</h1>
            <p class="lead">Encuentra la propiedad perfecta analizando miles de publicaciones por ti.</p>
        </header>

        <div class="card p-4 shadow-sm mb-5" id="search-form">
            <form method="post" action="" autocomplete="off">
                {% csrf_token %}
                <div class="row g-3 mb-2">
                    <div class="col-md-12">
                        <label for="keywords" class="form-label fw-bold text-center">¬øQu√© est√°s buscando?</label>
                        {% if search_data %}
                        <input type="text" name="keywords" id="keywords" class="form-control form-control-lg" placeholder="Ej: parrillero, luminoso, cerca de la rambla..." value="{{ search_data.keywords|join:', ' }}">
                        {% else %}
                        <input type="text" name="keywords" id="keywords" class="form-control form-control-lg" placeholder="Ej: parrillero, luminoso, cerca de la rambla...">
                        {% endif %}
                    </div>
                </div>
                <div class="row mb-3 justify-content-center">
                    <div class="col-12 d-flex justify-content-center align-items-center flex-wrap gap-2" id="botones-busqueda">
                        <button type="button" class="btn btn-secondary mx-1" onclick="toggleFilters()">Filtros</button>
                        <button type="submit" class="btn btn-primary mx-1">Buscar</button>
                        <button type="submit" name="guardar" value="1" class="btn btn-success mx-1">Buscar y Guardar</button>
                        <input type="text" name="name" id="name" class="form-control me-2" style="max-width: 200px;" placeholder="T√≠tulo para la b√∫squeda"
                            {% if search_data %} value="{{ search_data.name }}" {% endif %}>
                    </div>
                </div>
                <div id="filter-container" class="collapsed">
                    <div class="row g-3 mb-2">
                        <div class="col-md-3">
                            <label for="departamento" class="form-label">Departamento</label>
                            <select name="departamento" id="departamento" class="form-select" onchange="mostrarCiudades()">
                                <option value="">Todos</option>
                                <option>Montevideo</option>
                                <option>Artigas</option>
                                <option>Canelones</option>
                                <option>Cerro Largo</option>
                                <option>Colonia</option>
                                <option>Durazno</option>
                                <option>Flores</option>
                                <option>Florida</option>
                                <option>Lavalleja</option>
                                <option>Maldonado</option>
                                <option>Paysand√∫</option>
                                <option>Rivera</option>
                                <option>Rocha</option>
                                <option>R√≠o Negro</option>
                                <option>Salto</option>
                                <option>San Jos√©</option>
                                <option>Soriano</option>
                                <option>Tacuaremb√≥</option>
                                <option>Treinta y Tres</option>
                            </select>
                        </div>
                        <div class="col-md-3" id="ciudad_div" style="display:none">
                            <label for="ciudad" class="form-label">Ciudad (solo Montevideo)</label>
                            <select name="ciudad" id="ciudad" class="form-select">
                                <option value="">Todas</option>
                                <option>Aguada</option>
                                <option>Aires Puros</option>
                                <option>Arroyo Seco</option>
                                <option>Atahualpa</option>
                                <option>Barrio Sur</option>
                                <option>Bella Vista</option>
                                <option>Belvedere</option>
                                <option>Bolivar</option>
                                <option>Brazo Oriental</option>
                                <option>Buceo</option>
                                <option>Capurro</option>
                                <option>Carrasco</option>
                                <option>Carrasco Norte</option>
                                <option>Casavalle</option>
                                <option>Centro</option>
                                <option>Cerrito</option>
                                <option>Cerro</option>
                                <option>Ciudad Vieja</option>
                                <option>Col√≥n</option>
                                <option>Cord√≥n</option>
                                <option>Flor de Maro√±as</option>
                                <option>Goes</option>
                                <option>Ituzaing√≥</option>
                                <option>Jacinto Vera</option>
                                <option>Jardines Hip√≥dromo</option>
                                <option>La Blanqueada</option>
                                <option>La Comercial</option>
                                <option>La Figurita</option>
                                <option>La Teja</option>
                                <option>Larra√±aga</option>
                                <option>Las Acacias</option>
                                <option>Lezica</option>
                                <option>Malvin</option>
                                <option>Malvin Norte</option>
                                <option>Manga</option>
                                <option>Marconi</option>
                                <option>Maro√±as</option>
                                <option>Maro√±as, Curva</option>
                                <option>Melilla</option>
                                <option>Mercado Modelo</option>
                                <option>Montevideo</option>
                                <option>Nuevo Par√≠s</option>
                                <option>Palermo</option>
                                <option>Parque Batlle</option>
                                <option>Parque Rod√≥</option>
                                <option>Paso de la Arena</option>
                                <option>Paso Molino</option>
                                <option>Pe√±arol</option>
                                <option>Perez Castellanos</option>
                                <option>Piedras Blancas</option>
                                <option>Pocitos</option>
                                <option>Pocitos Nuevo</option>
                                <option>Prado</option>
                                <option>Puerto Buceo</option>
                                <option>Punta Carretas</option>
                                <option>Punta Gorda</option>
                                <option>Punta Rieles</option>
                                <option>Reducto</option>
                                <option>Santiago V√°zquez</option>
                                <option>Sayago</option>
                                <option>Tres Cruces</option>
                                <option>Uni√≥n</option>
                                <option>Villa Biarritz</option>
                                <option>Villa Dolores</option>
                                <option>Villa Espa√±ola</option>
                                <option>Villa Mu√±oz</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="operacion" class="form-label">Tipo de operaci√≥n</label>
                            <select name="operacion" id="operacion" class="form-select">
                                <option value="">Todas</option>
                                <option>Venta</option>
                                <option>Alquiler</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="tipo" class="form-label">Tipo de inmueble</label>
                            <select name="tipo" id="tipo" class="form-select">
                                <option value="">Todos</option>
                                <option>Apartamentos</option>
                                <option>Campos</option>
                                <option>Casas</option>
                                <option>Cocheras</option>
                                <option>Dep√≥sitos y galpones</option>
                                <option>Llave de negocio</option>
                                <option>Locales</option>
                                <option>Oficinas</option>
                                <option>Quintas</option>
                                <option>Terrenos</option>
                                <option>Otros inmuebles</option>
                            </select>
                        </div>
                    </div>
                    <div class="row g-3 mb-2">
                        <div class="col-md-3">
                            <label for="moneda" class="form-label">Moneda</label>
                            <select name="moneda" id="moneda" class="form-select">
                                <option value="USD" {% if search_data.filters.moneda == 'USD' or not search_data.filters.moneda %}selected{% endif %}>USD</option>
                                <option value="UYU" {% if search_data.filters.moneda == 'UYU' %}selected{% endif %}>UYU</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="precio_min" class="form-label">Precio m√≠nimo</label>
                            <input type="number" min="0" name="precio_min" id="precio_min" class="form-control" placeholder="Ej: 50000" value="{{ search_data.filters.precio_min|default:'' }}">
                        </div>
                        <div class="col-md-3">
                            <label for="precio_max" class="form-label">Precio m√°ximo</label>
                            <input type="number" min="0" name="precio_max" id="precio_max" class="form-control" placeholder="Ej: 200000" value="{{ search_data.filters.precio_max|default:'' }}">
                        </div>
                        <div class="col-md-3">
                            <label for="name" class="form-label">T√≠tulo para la b√∫squeda:</label>
                            {% if search_data %}
                            <input type="text" name="name" id="name" class="form-control" value="{{ search_data.name }}">
                            {% else %}
                            <input type="text" name="name" id="name" class="form-control">
                            {% endif %}
                        </div>
                    </div>
                    <div class="row g-3 mb-2">
                        <div class="col-md-2">
                            <label for="dormitorios_min" class="form-label">Dorm. min</label>
                            <input type="number" min="0" name="dormitorios_min" id="dormitorios_min" class="form-control" placeholder="Ej: 2" value="{{ search_data.filters.dormitorios_min|default:'' }}">
                        </div>
                        <div class="col-md-2">
                            <label for="dormitorios_max" class="form-label">Dorm. max</label>
                            <input type="number" min="0" name="dormitorios_max" id="dormitorios_max" class="form-control" placeholder="Ej: 4" value="{{ search_data.filters.dormitorios_max|default:'' }}">
                        </div>
                        <div class="col-md-2">
                            <label for="banos_min" class="form-label">Ba√±os min</label>
                            <input type="number" min="0" name="banos_min" id="banos_min" class="form-control" placeholder="Ej: 1" value="{{ search_data.filters.banos_min|default:'' }}">
                        </div>
                        <div class="col-md-2">
                            <label for="banos_max" class="form-label">Ba√±os max</label>
                            <input type="number" min="0" name="banos_max" id="banos_max" class="form-control" placeholder="Ej: 3" value="{{ search_data.filters.banos_max|default:'' }}">
                        </div>
                        <div class="col-md-2">
                            <label for="cocheras_min" class="form-label">Coch. min</label>
                            <input type="number" min="0" name="cocheras_min" id="cocheras_min" class="form-control" placeholder="Ej: 1" value="{{ search_data.filters.cocheras_min|default:'' }}">
                        </div>
                        <div class="col-md-2">
                            <label for="cocheras_max" class="form-label">Coch. max</label>
                            <input type="number" min="0" name="cocheras_max" id="cocheras_max" class="form-control" placeholder="Ej: 2" value="{{ search_data.filters.cocheras_max|default:'' }}">
                        </div>
                    </div>
                    <div class="row g-3 mb-2">
                        <div class="col-md-3">
                            <label for="antiguedad_min" class="form-label">Antig√ºedad min</label>
                            <input type="number" min="0" name="antiguedad_min" id="antiguedad_min" class="form-control" placeholder="Ej: 0" value="{{ search_data.filters.antiguedad_min|default:'' }}">
                        </div>
                        <div class="col-md-3">
                            <label for="antiguedad_max" class="form-label">Antig√ºedad max</label>
                            <input type="number" min="0" name="antiguedad_max" id="antiguedad_max" class="form-control" placeholder="Ej: 20" value="{{ search_data.filters.antiguedad_max|default:'' }}">
                        </div>
                        <div class="col-md-3">
                            <label for="superficie_total_min" class="form-label">Sup. total min</label>
                            <input type="number" min="0" step="any" name="superficie_total_min" id="superficie_total_min" class="form-control" placeholder="Ej: 100" value="{{ search_data.filters.superficie_total_min|default:'' }}">
                        </div>
                        <div class="col-md-3">
                            <label for="superficie_total_max" class="form-label">Sup. total max</label>
                            <input type="number" min="0" step="any" name="superficie_total_max" id="superficie_total_max" class="form-control" placeholder="Ej: 500" value="{{ search_data.filters.superficie_total_max|default:'' }}">
                        </div>
                    </div>
                    <div class="row g-3 mb-2">
                        <div class="col-md-3">
                            <label for="superficie_cubierta_min" class="form-label">Sup. cubierta min</label>
                            <input type="number" min="0" step="any" name="superficie_cubierta_min" id="superficie_cubierta_min" class="form-control" placeholder="Ej: 80" value="{{ search_data.filters.superficie_cubierta_min|default:'' }}">
                        </div>
                        <div class="col-md-3">
                            <label for="superficie_cubierta_max" class="form-label">Sup. cubierta max</label>
                            <input type="number" min="0" step="any" name="superficie_cubierta_max" id="superficie_cubierta_max" class="form-control" placeholder="Ej: 300" value="{{ search_data.filters.superficie_cubierta_max|default:'' }}">
                        </div>
                    </div>
                    <div class="row g-3 mb-2">
                        <div class="col-12">
                            <h6><b>Otras caracter√≠sticas</b></h6>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="checkbox" name="amoblado" id="amoblado" {% if search_data.filters.amoblado %}checked{% endif %}>
                                <label class="form-check-label" for="amoblado">Amoblado</label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="checkbox" name="terraza" id="terraza" {% if search_data.filters.terraza %}checked{% endif %}>
                                <label class="form-check-label" for="terraza">Terraza</label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="checkbox" name="aire_acondicionado" id="aire_acondicionado" {% if search_data.filters.aire_acondicionado %}checked{% endif %}>
                                <label class="form-check-label" for="aire_acondicionado">Aire acondicionado</label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="checkbox" name="piscina" id="piscina" {% if search_data.filters.piscina %}checked{% endif %}>
                                <label class="form-check-label" for="piscina">Piscina</label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="checkbox" name="jardin" id="jardin" {% if search_data.filters.jardin %}checked{% endif %}>
                                <label class="form-check-label" for="jardin">Jard√≠n</label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="checkbox" name="ascensor" id="ascensor" {% if search_data.filters.ascensor %}checked{% endif %}>
                                <label class="form-check-label" for="ascensor">Ascensor</label>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-12 text-center">
                        <div id="boton-detener" style="display:none;" class="mt-2">
                            <button type="button" class="btn btn-warning mx-2" onclick="detenerBusqueda()">Detener b√∫squeda</button>
                        </div>
                    </div>
                </div>
            </form>
        </div>

        <div id="search-progress" class="card p-4 shadow-sm mb-4" style="display:none;">
            <h3 class="mb-3" id="progress-title">Progreso de la b√∫squeda</h3>
            <p id="progress-status"><strong>Estado:</strong> <span id="current-search-item">Iniciando...</span></p>
            <div id="results-list" style="display:none;">
                <ul class="list-group" id="matched-properties-list">
                    <!-- Los resultados se llenar√°n din√°micamente -->
                </ul>
            </div>
        </div>

        {% if results is not None %}
        <div id="resultados">
            <h2 class="mb-4">Resultados encontrados: {{ results|length }}</h2>
            <ul class="list-group mb-4">
                {% for r in results %}
                    <li class="list-group-item animate__animated animate__fadeInUp">
                        <a href="{{ r.url }}" target="_blank" class="fw-bold text-decoration-none">{{ r.titulo|default:r.url }}</a>
                    </li>
                {% empty %}
                    <li class="list-group-item animate__animated animate__fadeInUp">No se encontraron propiedades con los criterios seleccionados.</li>
                {% endfor %}
            </ul>
        </div>
        {% endif %}

        <div class="mt-5">
            <h3>B√∫squedas guardadas</h3>
            <ul class="list-group" id="busquedas-guardadas">
                {% for search in searches %}
                    <li class="list-group-item d-flex flex-column" id="search-{{ search.id }}">
                        <div class="d-flex justify-content-between align-items-center">
                            <a href="#" onclick="expandirBusqueda('{{ search.id }}'); return false;" class="fw-bold">{{ search.nombre }}</a>
                            <a href="{% url 'core:delete_search' search.id %}" class="btn btn-sm btn-danger">Eliminar</a>
                        </div>
                        <div class="busqueda-detalle mt-3 p-0" style="display:none; transition: all 0.3s; border-radius: 0.5rem;"></div>
                    </li>
                {% empty %}
                    <li class="list-group-item">No hay b√∫squedas guardadas.</li>
                {% endfor %}
            </ul>
        </div>
    </div>
    <script>
    function expandirBusqueda(searchId) {
        var detalleDiv = document.querySelector('#search-' + searchId + ' .busqueda-detalle');
        if (detalleDiv.style.display === 'none') {
            fetch('/ajax/busqueda/' + searchId + '/')
                .then(response => response.json())
                .then(data => {
                    detalleDiv.innerHTML = `<div class='card shadow-sm border-0 bg-light p-4 mb-3 animate__animated animate__fadeIn'>${data.html}</div>`;
                    detalleDiv.style.display = 'block';
                    setTimeout(function() {
                        detalleDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }, 200);
                });
        } else {
            detalleDiv.innerHTML = '';
            detalleDiv.style.display = 'none';
        }
    }

    function mostrarCiudades() {
        var dep = document.getElementById('departamento').value;
        document.getElementById('ciudad_div').style.display = (dep === 'Montevideo') ? '' : 'none';
    }

    function toggleFilters() {
        var filterContainer = document.getElementById('filter-container');
        filterContainer.classList.toggle('collapsed');
    }

    let buscando = false;
    function iniciarBusqueda() {
        buscando = true;
        document.getElementById('botones-busqueda').style.display = 'none';
        document.getElementById('boton-detener').style.display = 'block';
        document.getElementById('filter-container').classList.add('collapsed');

        // Mostrar y resetear la secci√≥n de progreso
        const searchProgressDiv = document.getElementById('search-progress');
        searchProgressDiv.style.display = 'block';
        resetProgressView(); // Resetear a vista de progreso
    }

    function finalizarBusqueda() {
        buscando = false;
        document.getElementById('botones-busqueda').style.display = 'block';
        document.getElementById('boton-detener').style.display = 'none';
        // No volvemos a expandir los filtros autom√°ticamente para que el usuario vea los resultados.
        // El usuario puede volver a abrirlos con el bot√≥n "Filtros".
    }

    function detenerBusqueda() {
        fetch('/detener_busqueda/', {method: 'POST', headers: {'X-CSRFToken': '{{ csrf_token }}'}})
            .then(() => {
                finalizarBusqueda();
            });
    }

    function updateMatchedPublications(matchedPublications) {
        const resultsList = document.getElementById('matched-properties-list');
        resultsList.innerHTML = ''; // Limpiar lista anterior
        
        matchedPublications.forEach(publication => {
            const li = document.createElement('li');
            li.className = 'list-group-item animate__animated animate__fadeInUp';
            li.innerHTML = `<a href="${publication.url}" target="_blank" class="fw-bold text-decoration-none">${publication.title}</a>`;
            resultsList.appendChild(li);
        });
    }

    function showResults(matchedPublications) {
        const progressTitle = document.getElementById('progress-title');
        const progressStatus = document.getElementById('progress-status');
        const resultsList = document.getElementById('results-list');
        
        // Cambiar t√≠tulo y ocultar estado de progreso
        const count = matchedPublications ? matchedPublications.length : 0;
        progressTitle.textContent = `Resultados encontrados: ${count}`;
        progressStatus.style.display = 'none';
        
        // Mostrar lista de resultados
        if (matchedPublications && matchedPublications.length > 0) {
            updateMatchedPublications(matchedPublications);
            resultsList.style.display = 'block';
        } else {
            // Mostrar mensaje cuando no hay resultados
            const resultsList = document.getElementById('matched-properties-list');
            resultsList.innerHTML = '<li class="list-group-item">No se encontraron propiedades con los criterios seleccionados.</li>';
            document.getElementById('results-list').style.display = 'block';
        }
    }

    function resetProgressView() {
        const progressTitle = document.getElementById('progress-title');
        const progressStatus = document.getElementById('progress-status');
        const resultsList = document.getElementById('results-list');
        
        // Restaurar vista de progreso
        progressTitle.textContent = 'Progreso de la b√∫squeda';
        progressStatus.style.display = 'block';
        resultsList.style.display = 'none';
        document.getElementById('current-search-item').textContent = 'Iniciando...';
    }

    document.addEventListener('DOMContentLoaded', function() {
        mostrarCiudades();
        
        // WebSocket setup PRIMERO
        const searchProgressSocket = new WebSocket(
            'ws://' +
            window.location.host +
            '/ws/search_progress/'
        );

        const searchProgressDiv = document.getElementById('search-progress');
        const currentSearchItemSpan = document.getElementById('current-search-item');

        searchProgressSocket.onmessage = function(e) {
            const data = JSON.parse(e.data);
            const message = data.message;
            console.log('üîç [DEBUG] Mensaje recibido:', message); // Debug

            searchProgressDiv.style.display = 'block'; // Show progress div

            // Manejar tanto objetos como strings en el mensaje
            if (typeof message === 'object') {
                if (message.current_search_item !== undefined && message.current_search_item !== null) {
                    currentSearchItemSpan.textContent = message.current_search_item;
                }
                
                // Actualizar lista de publicaciones coincidentes durante la b√∫squeda
                if (message.matched_publications && Array.isArray(message.matched_publications)) {
                    console.log('üìù [DEBUG] Publicaciones coincidentes:', message.matched_publications); // Debug
                    updateMatchedPublications(message.matched_publications);
                }
                
                if (message.final_message !== undefined && message.final_message !== null) {
                    console.log('üéØ [DEBUG] Mensaje final con publicaciones:', message.matched_publications); // Debug
                    // Cambiar a vista de resultados
                    showResults(message.matched_publications || []);
                    searchProgressDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    finalizarBusqueda(); // Call finalizarBusqueda when search is done
                }
            } else if (typeof message === 'string') {
                // Manejar mensajes de string simples (para compatibilidad)
                currentSearchItemSpan.textContent = message;
                // Si el mensaje indica finalizaci√≥n, finalizar b√∫squeda
                if (message.includes('finalizada') || message.includes('detenida') || message.includes('Error')) {
                    showResults([]);
                    searchProgressDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    finalizarBusqueda();
                }
            }
        };

        searchProgressSocket.onclose = function(e) {
            console.error('Search progress socket closed unexpectedly', e);
            finalizarBusqueda();
        };

        searchProgressSocket.onerror = function(e) {
            console.error('Search progress socket error', e);
            finalizarBusqueda();
        };
        
        // Configurar formulario DESPU√âS de definir el WebSocket
        var form = document.querySelector('form');
        form.addEventListener('submit', function(e) {
            e.preventDefault(); // Evita la recarga de la p√°gina
            iniciarBusqueda();
            // Recolectar datos del formulario
            const formData = new FormData(form);
            let texto = '';
            const filtros = {};
            for (const [key, value] of formData.entries()) {
                if (key === 'csrfmiddlewaretoken') continue;
                if (key === 'keywords') {
                    texto = value;
                } else if (value !== '') {
                    filtros[key] = value;
                }
            }
            const payload = {
                texto: texto,
                filtros: filtros
            };
            // Enviar por WebSocket
            if (searchProgressSocket.readyState === WebSocket.OPEN) {
                console.log('üöÄ [FRONTEND] Enviando b√∫squeda por WebSocket:', payload);
                searchProgressSocket.send(JSON.stringify(payload));
            } else {
                console.warn('‚ùå [FRONTEND] WebSocket no est√° abierto, estado:', searchProgressSocket.readyState);
            }
        });
    });
    </script>
</body>
</html>