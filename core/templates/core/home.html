<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Buscador Inmobiliario Inteligente</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    <style>
        .card-img-top { height: 220px; object-fit: cover; }
        .busqueda-detalle .card {
            border-radius: 0.75rem;
            box-shadow: 0 2px 16px rgba(0,0,0,0.08);
            background: linear-gradient(135deg, #f8fafc 0%, #e9ecef 100%);
        }
        .busqueda-detalle h2, .busqueda-detalle h3 {
            font-weight: 700;
            color: #2c3e50;
        }
        .busqueda-detalle ul {
            padding-left: 1.2rem;
        }
        .busqueda-detalle li {
            margin-bottom: 0.5rem;
            font-size: 1.08rem;
        }
        .busqueda-detalle a.btn, .busqueda-detalle button {
            margin-top: 1rem;
        }
        .busqueda-detalle .alert-warning {
            border-radius: 0.5rem;
        }
        #filter-container {
            max-height: 1000px; /* Altura suficientemente grande para contener los filtros */
            overflow: hidden;
            transition: max-height 0.5s ease-in-out;
        }
        #filter-container.collapsed {
            max-height: 0;
        }
    </style>
</head>
<body>
    <div class="container my-4">
        <header class="text-center mb-5">
            <h1>Buscador de Propiedades</h1>
            <p class="lead">Encuentra la propiedad perfecta analizando miles de publicaciones por ti.</p>
            <!--
            <div class="mt-2">
                <a href="/debug_screenshots/" class="btn btn-outline-secondary btn-sm">
                    📸 Ver Capturas Debug
                </a>
                <small class="text-muted d-block mt-1">
                    (Útil cuando el scraper no encuentra totales)
                </small>
            </div>
        -->            
        </header>

        <div class="card p-4 shadow-sm mb-5" id="search-form">
            <form method="post" action="" autocomplete="off">
                {% csrf_token %}
                <div class="row g-3 mb-2">
                    <div class="col-md-12 text-center">
                        <label for="keywords" class="form-label fw-bold">¿Qué estás buscando?</label>
                        {% if search_data %}
                        <input type="text" name="keywords" id="keywords" class="form-control form-control-lg" placeholder="Ej: parrillero, luminoso, cerca de la rambla..." value="{{ search_data.keywords|join:', ' }}">
                        {% else %}
                        <input type="text" name="keywords" id="keywords" class="form-control form-control-lg" placeholder="Ej: parrillero, luminoso, cerca de la rambla...">
                        {% endif %}
                    </div>
                </div>
                <div class="row mb-3 justify-content-center">
                    <div class="col-12 d-flex justify-content-center align-items-center flex-wrap gap-2" id="botones-busqueda">
                        <button type="button" class="btn btn-secondary mx-1" onclick="toggleFilters()">Filtros</button>
                        <button type="submit" class="btn btn-primary mx-1">Buscar</button>
                        <button type="submit" name="guardar" value="1" class="btn btn-success mx-1">Buscar y Guardar</button>
                        <input type="text" name="name" id="name" class="form-control me-2" style="max-width: 200px;" placeholder="Título para la búsqueda"
                            {% if search_data %} value="{{ search_data.name }}" {% endif %}>
                    </div>
                </div>
                <div id="filter-container" class="collapsed">
                    <div class="row g-3 mb-2">
                        <div class="col-md-3">
                            <label for="departamento" class="form-label">Departamento</label>
                            <select name="departamento" id="departamento" class="form-select" onchange="mostrarCiudades()">
                                <option value="">Todos</option>
                                <option>Montevideo</option>
                                <option>Artigas</option>
                                <option>Canelones</option>
                                <option>Cerro Largo</option>
                                <option>Colonia</option>
                                <option>Durazno</option>
                                <option>Flores</option>
                                <option>Florida</option>
                                <option>Lavalleja</option>
                                <option>Maldonado</option>
                                <option>Paysandú</option>
                                <option>Rivera</option>
                                <option>Rocha</option>
                                <option>Río Negro</option>
                                <option>Salto</option>
                                <option>San José</option>
                                <option>Soriano</option>
                                <option>Tacuarembó</option>
                                <option>Treinta y Tres</option>
                            </select>
                        </div>
                        <div class="col-md-3" id="ciudad_div" style="display:none">
                            <label for="ciudad" class="form-label">Ciudad (solo Montevideo)</label>
                            <select name="ciudad" id="ciudad" class="form-select">
                                <option value="">Todas</option>
                                <option>Aguada</option>
                                <option>Aires Puros</option>
                                <option>Arroyo Seco</option>
                                <option>Atahualpa</option>
                                <option>Barrio Sur</option>
                                <option>Bella Vista</option>
                                <option>Belvedere</option>
                                <option>Bolivar</option>
                                <option>Brazo Oriental</option>
                                <option>Buceo</option>
                                <option>Capurro</option>
                                <option>Carrasco</option>
                                <option>Carrasco Norte</option>
                                <option>Casavalle</option>
                                <option>Centro</option>
                                <option>Cerrito</option>
                                <option>Cerro</option>
                                <option>Ciudad Vieja</option>
                                <option>Colón</option>
                                <option>Cordón</option>
                                <option>Flor de Maroñas</option>
                                <option>Goes</option>
                                <option>Ituzaingó</option>
                                <option>Jacinto Vera</option>
                                <option>Jardines Hipódromo</option>
                                <option>La Blanqueada</option>
                                <option>La Comercial</option>
                                <option>La Figurita</option>
                                <option>La Teja</option>
                                <option>Larrañaga</option>
                                <option>Las Acacias</option>
                                <option>Lezica</option>
                                <option>Malvin</option>
                                <option>Malvin Norte</option>
                                <option>Manga</option>
                                <option>Marconi</option>
                                <option>Maroñas</option>
                                <option>Maroñas, Curva</option>
                                <option>Melilla</option>
                                <option>Mercado Modelo</option>
                                <option>Montevideo</option>
                                <option>Nuevo París</option>
                                <option>Palermo</option>
                                <option>Parque Batlle</option>
                                <option>Parque Rodó</option>
                                <option>Paso de la Arena</option>
                                <option>Paso Molino</option>
                                <option>Peñarol</option>
                                <option>Perez Castellanos</option>
                                <option>Piedras Blancas</option>
                                <option>Pocitos</option>
                                <option>Pocitos Nuevo</option>
                                <option>Prado</option>
                                <option>Puerto Buceo</option>
                                <option>Punta Carretas</option>
                                <option>Punta Gorda</option>
                                <option>Punta Rieles</option>
                                <option>Reducto</option>
                                <option>Santiago Vázquez</option>
                                <option>Sayago</option>
                                <option>Tres Cruces</option>
                                <option>Unión</option>
                                <option>Villa Biarritz</option>
                                <option>Villa Dolores</option>
                                <option>Villa Española</option>
                                <option>Villa Muñoz</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="operacion" class="form-label">Tipo de operación</label>
                            <select name="operacion" id="operacion" class="form-select">
                                <option value="">Todas</option>
                                <option>Venta</option>
                                <option>Alquiler</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="tipo" class="form-label">Tipo de inmueble</label>
                            <select name="tipo" id="tipo" class="form-select">
                                <option value="">Todos</option>
                                <option>Apartamentos</option>
                                <option>Campos</option>
                                <option>Casas</option>
                                <option>Cocheras</option>
                                <option>Depósitos y galpones</option>
                                <option>Llave de negocio</option>
                                <option>Locales</option>
                                <option>Oficinas</option>
                                <option>Quintas</option>
                                <option>Terrenos</option>
                                <option>Otros inmuebles</option>
                            </select>
                        </div>
                    </div>
                    <div class="row g-3 mb-2">
                        <div class="col-md-3">
                            <label for="moneda" class="form-label">Moneda</label>
                            <select name="moneda" id="moneda" class="form-select" style="width: 75%;">
                                <option value="USD" {% if search_data.filters.moneda == 'USD' or not search_data.filters.moneda %}selected{% endif %}>USD</option>
                                <option value="UYU" {% if search_data.filters.moneda == 'UYU' %}selected{% endif %}>UYU</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="precio_min" class="form-label">Precio mínimo</label>
                            <input type="number" min="0" name="precio_min" id="precio_min" class="form-control" placeholder="Ej: 50000" value="{{ search_data.filters.precio_min|default:'' }}">
                        </div>
                        <div class="col-md-3">
                            <label for="precio_max" class="form-label">Precio máximo</label>
                            <input type="number" min="0" name="precio_max" id="precio_max" class="form-control" placeholder="Ej: 200000" value="{{ search_data.filters.precio_max|default:'' }}">
                        </div>
                    </div>
                    <div class="row g-3 mb-2">
                        <div class="col-md-2">
                            <label for="dormitorios_min" class="form-label">Dorm. min</label>
                            <input type="number" min="0" name="dormitorios_min" id="dormitorios_min" class="form-control" placeholder="Ej: 2" value="{{ search_data.filters.dormitorios_min|default:'' }}">
                        </div>
                        <div class="col-md-2">
                            <label for="dormitorios_max" class="form-label">Dorm. max</label>
                            <input type="number" min="0" name="dormitorios_max" id="dormitorios_max" class="form-control" placeholder="Ej: 4" value="{{ search_data.filters.dormitorios_max|default:'' }}">
                        </div>
                        <div class="col-md-2">
                            <label for="banos_min" class="form-label">Baños min</label>
                            <input type="number" min="0" name="banos_min" id="banos_min" class="form-control" placeholder="Ej: 1" value="{{ search_data.filters.banos_min|default:'' }}">
                        </div>
                        <div class="col-md-2">
                            <label for="banos_max" class="form-label">Baños max</label>
                            <input type="number" min="0" name="banos_max" id="banos_max" class="form-control" placeholder="Ej: 3" value="{{ search_data.filters.banos_max|default:'' }}">
                        </div>
                        <div class="col-md-2">
                            <label for="cocheras_min" class="form-label">Coch. min</label>
                            <input type="number" min="0" name="cocheras_min" id="cocheras_min" class="form-control" placeholder="Ej: 1" value="{{ search_data.filters.cocheras_min|default:'' }}">
                        </div>
                        <div class="col-md-2">
                            <label for="cocheras_max" class="form-label">Coch. max</label>
                            <input type="number" min="0" name="cocheras_max" id="cocheras_max" class="form-control" placeholder="Ej: 2" value="{{ search_data.filters.cocheras_max|default:'' }}">
                        </div>
                    </div>
                    <div class="row g-3 mb-2">
                        <div class="col-md-3">
                            <label for="antiguedad_min" class="form-label">Antigüedad min</label>
                            <input type="number" min="0" name="antiguedad_min" id="antiguedad_min" class="form-control" placeholder="Ej: 0" value="{{ search_data.filters.antiguedad_min|default:'' }}">
                        </div>
                        <div class="col-md-3">
                            <label for="antiguedad_max" class="form-label">Antigüedad max</label>
                            <input type="number" min="0" name="antiguedad_max" id="antiguedad_max" class="form-control" placeholder="Ej: 20" value="{{ search_data.filters.antiguedad_max|default:'' }}">
                        </div>
                        <div class="col-md-3">
                            <label for="superficie_total_min" class="form-label">Sup. total min</label>
                            <input type="number" min="0" step="any" name="superficie_total_min" id="superficie_total_min" class="form-control" placeholder="Ej: 100" value="{{ search_data.filters.superficie_total_min|default:'' }}">
                        </div>
                        <div class="col-md-3">
                            <label for="superficie_total_max" class="form-label">Sup. total max</label>
                            <input type="number" min="0" step="any" name="superficie_total_max" id="superficie_total_max" class="form-control" placeholder="Ej: 500" value="{{ search_data.filters.superficie_total_max|default:'' }}">
                        </div>
                    </div>
                    <div class="row g-3 mb-2">
                        <div class="col-md-3">
                            <label for="superficie_cubierta_min" class="form-label">Sup. cubierta min</label>
                            <input type="number" min="0" step="any" name="superficie_cubierta_min" id="superficie_cubierta_min" class="form-control" placeholder="Ej: 80" value="{{ search_data.filters.superficie_cubierta_min|default:'' }}">
                        </div>
                        <div class="col-md-3">
                            <label for="superficie_cubierta_max" class="form-label">Sup. cubierta max</label>
                            <input type="number" min="0" step="any" name="superficie_cubierta_max" id="superficie_cubierta_max" class="form-control" placeholder="Ej: 300" value="{{ search_data.filters.superficie_cubierta_max|default:'' }}">
                        </div>
                    </div>
                    <div class="row g-3 mb-2">
                        <div class="col-12">
                            <h6><b>Otras características</b></h6>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="checkbox" name="amoblado" id="amoblado" {% if search_data.filters.amoblado %}checked{% endif %}>
                                <label class="form-check-label" for="amoblado">Amoblado</label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="checkbox" name="terraza" id="terraza" {% if search_data.filters.terraza %}checked{% endif %}>
                                <label class="form-check-label" for="terraza">Terraza</label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="checkbox" name="aire_acondicionado" id="aire_acondicionado" {% if search_data.filters.aire_acondicionado %}checked{% endif %}>
                                <label class="form-check-label" for="aire_acondicionado">Aire acondicionado</label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="checkbox" name="piscina" id="piscina" {% if search_data.filters.piscina %}checked{% endif %}>
                                <label class="form-check-label" for="piscina">Piscina</label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="checkbox" name="jardin" id="jardin" {% if search_data.filters.jardin %}checked{% endif %}>
                                <label class="form-check-label" for="jardin">Jardín</label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="checkbox" name="ascensor" id="ascensor" {% if search_data.filters.ascensor %}checked{% endif %}>
                                <label class="form-check-label" for="ascensor">Ascensor</label>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-12 text-center">
                        <div id="boton-detener" style="display:none;" class="mt-2">
                            <button type="button" class="btn btn-warning mx-2" onclick="detenerBusqueda()">Detener búsqueda</button>
                        </div>
                    </div>
                </div>
            </form>
        </div>

        <div id="search-progress" class="card p-4 shadow-sm mb-4" style="display:none;">
            <h3 class="mb-3" id="progress-title">Progreso de la búsqueda</h3>
            <p id="progress-status"><strong>Estado:</strong> <span id="current-search-item">Iniciando...</span></p>
            <div id="results-list" style="display:none;">
                <div id="nuevas-section" style="display:none;">
                    <h4 class="mt-3 mb-2">🆕 Nuevas</h4>
                    <ul class="list-group" id="nuevas-properties-list">
                        <!-- Las propiedades nuevas se llenarán dinámicamente -->
                    </ul>
                </div>
                <div id="existentes-section" style="display:none;">
                    <h4 class="mt-3 mb-2">📋 Encontradas anteriormente</h4>
                    <ul class="list-group" id="existentes-properties-list">
                        <!-- Las propiedades existentes se llenarán dinámicamente -->
                    </ul>
                </div>
            </div>
        </div>

        {% if results is not None %}
        <div id="resultados">
            <h2 class="mb-4">Resultados encontrados: {{ results|length }}</h2>
            <ul class="list-group mb-4">
                {% for r in results %}
                    <li class="list-group-item animate__animated animate__fadeInUp">
                        <a href="{{ r.url }}" target="_blank" class="fw-bold text-decoration-none">{{ r.titulo|default:r.url }}</a>
                    </li>
                {% empty %}
                    <li class="list-group-item animate__animated animate__fadeInUp">No se encontraron propiedades con los criterios seleccionados.</li>
                {% endfor %}
            </ul>
        </div>
        {% endif %}

        <!-- Mensajes de Django -->
        {% if messages %}
            {% for message in messages %}
                <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                    <strong>
                        {% if message.tags == 'success' %}✅{% elif message.tags == 'error' %}❌{% elif message.tags == 'warning' %}⚠️{% else %}ℹ️{% endif %}
                    </strong>
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            {% endfor %}
        {% endif %}
        
        <div class="mt-5">
            <h3>Búsquedas guardadas</h3>
            <ul class="list-group" id="busquedas-guardadas">
                {% for search in searches %}
                    <li class="list-group-item d-flex flex-column" id="search-{{ search.id }}">
                        <div class="d-flex justify-content-between align-items-center">
                            <a href="#" onclick="expandirBusqueda('{{ search.id }}'); return false;" class="fw-bold">
                                {{ search.nombre_busqueda|default:search.texto_original|default:'(sin título)' }}
                            </a>
                            <a href="{% url 'core:delete_search' search.id %}" class="btn btn-sm btn-danger">Eliminar</a>
                        </div>
                        <div class="busqueda-detalle mt-3 p-0" style="display:none; transition: all 0.3s; border-radius: 0.5rem;"></div>
                    </li>
                {% empty %}
                    <li class="list-group-item">No hay búsquedas guardadas.</li>
                {% endfor %}
            </ul>
        </div>
    </div>
    <script>
    function expandirBusqueda(searchId) {
        var detalleDiv = document.querySelector('#search-' + searchId + ' .busqueda-detalle');
        if (detalleDiv.style.display === 'none') {
            fetch('/ajax/busqueda/' + searchId + '/')
                .then(response => response.json())
                .then(data => {
                    detalleDiv.innerHTML = `<div class='card shadow-sm border-0 bg-light p-4 mb-3 animate__animated animate__fadeIn'>${data.html}</div>`;
                    detalleDiv.style.display = 'block';
                    setTimeout(function() {
                        detalleDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }, 200);
                });
        } else {
            detalleDiv.innerHTML = '';
            detalleDiv.style.display = 'none';
        }
    }

    function mostrarCiudades() {
        var dep = document.getElementById('departamento').value;
        document.getElementById('ciudad_div').style.display = (dep === 'Montevideo') ? '' : 'none';
    }

    function toggleFilters() {
        var filterContainer = document.getElementById('filter-container');
        filterContainer.classList.toggle('collapsed');
    }

    function mostrarCapturaDebug(screenshotPath) {
        console.log('📸 [DEBUG] Mostrando captura:', screenshotPath);
        
        // Buscar o crear el contenedor de debug
        let debugContainer = document.getElementById('debug-screenshots-container');
        if (!debugContainer) {
            debugContainer = document.createElement('div');
            debugContainer.id = 'debug-screenshots-container';
            debugContainer.className = 'alert alert-warning mt-3';
            debugContainer.innerHTML = `
                <h5><i class="bi bi-camera"></i> 📸 Capturas de Debug</h5>
                <p>Se capturó la pantalla para debugging cuando no se pudo extraer el total de resultados:</p>
                <div id="debug-screenshots-list"></div>
            `;
            
            // Insertarlo después del search-progress
            const searchProgress = document.getElementById('search-progress');
            searchProgress.parentNode.insertBefore(debugContainer, searchProgress.nextSibling);
        }
        
        // Agregar la nueva captura
        const screenshotsList = document.getElementById('debug-screenshots-list');
        const screenshotItem = document.createElement('div');
        screenshotItem.className = 'mb-2';
        screenshotItem.innerHTML = `
            <a href="${screenshotPath}" target="_blank" class="btn btn-outline-primary btn-sm">
                <i class="bi bi-eye"></i> Ver Captura (${new Date().toLocaleTimeString()})
            </a>
        `;
        screenshotsList.appendChild(screenshotItem);
        
        // Scroll hacia el debug container
        debugContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    let buscando = false;
    // Flag global: indica si la ejecución actual fue iniciada con "Buscar y Guardar".
    // Debe ser global porque es usada por funciones definidas en el scope global (p. ej., showResults).
    let currentSearchIsInitialSave = false;
    function iniciarBusqueda() {
        buscando = true;
        document.getElementById('botones-busqueda').style.display = 'none';
        document.getElementById('boton-detener').style.display = 'block';
        document.getElementById('filter-container').classList.add('collapsed');

        // Mostrar y resetear la sección de progreso
        const searchProgressDiv = document.getElementById('search-progress');
        searchProgressDiv.style.display = 'block';
        resetProgressView(); // Resetear a vista de progreso
    }

    function finalizarBusqueda() {
        buscando = false;
        document.getElementById('botones-busqueda').style.display = 'block';
        document.getElementById('boton-detener').style.display = 'none';
        // No volvemos a expandir los filtros automáticamente para que el usuario vea los resultados.
        // El usuario puede volver a abrirlos con el botón "Filtros".
        // Restablecer la flag de búsqueda inicial guardada si estaba activa
        try {
            currentSearchIsInitialSave = false;
        } catch (e) {
            // Silencioso: si la variable no existe por algún motivo, no fallar
        }
    }

    function detenerBusqueda() {
        fetch('/detener_busqueda/', {method: 'POST', headers: {'X-CSRFToken': '{{ csrf_token }}'}})
            .then(() => {
                finalizarBusqueda();
            });
    }

    function updateMatchedPublications(matchedPublications) {
        // Función de compatibilidad - solo actualiza nuevas durante el progreso
        updateNuevasPublications(matchedPublications || []);
    }

    function updateNuevasPublications(nuevasPublications) {
        const nuevasList = document.getElementById('nuevas-properties-list');
        const nuevasSection = document.getElementById('nuevas-section');
    // Debug: mostrar en consola los datos recibidos
    try { console.debug('updateNuevasPublications - count:', (nuevasPublications || []).length, nuevasPublications && nuevasPublications[0]); } catch(e) {}
        
        // Filtrar solo propiedades coincidentes (respaldo en frontend)
        const filteredPublications = (nuevasPublications || []).filter(publication => {
            // Si no tiene campo coincide, asumir que coincide (compatibilidad)
            return publication.coincide !== false;
        });
        
        if (filteredPublications && filteredPublications.length > 0) {
            nuevasList.innerHTML = ''; // Limpiar lista anterior
            filteredPublications.forEach(publication => {
                const li = document.createElement('li');
                li.className = 'list-group-item animate__animated animate__fadeInUp';
                // Compatibilidad con diferentes formatos de datos (title / titulo, url / link)
                const title = publication.title || publication.titulo || publication.titulo || publication.nombre || publication.name || '';
                const url = publication.url || publication.link || publication.href || '#';
                li.innerHTML = `<a href="${url}" target="_blank" class="fw-bold text-decoration-none">${title || url}</a>`;
                nuevasList.appendChild(li);
            });
            nuevasSection.style.display = 'block';
        } else {
            nuevasSection.style.display = 'none';
        }
    }

    function updateExistentesPublications(existentesPublications) {
        const existentesList = document.getElementById('existentes-properties-list');
        const existentesSection = document.getElementById('existentes-section');
        
        // Filtrar solo propiedades coincidentes (respaldo en frontend)
        const filteredPublications = (existentesPublications || []).filter(publication => {
            // Si no tiene campo coincide, asumir que coincide (compatibilidad)
            return publication.coincide !== false;
        });
        
        if (filteredPublications && filteredPublications.length > 0) {
            existentesList.innerHTML = ''; // Limpiar lista anterior
            filteredPublications.forEach(publication => {
                const li = document.createElement('li');
                li.className = 'list-group-item animate__animated animate__fadeInUp';
                const title = publication.title || publication.titulo || publication.nombre || publication.name || '';
                const url = publication.url || publication.link || publication.href || '#';
                li.innerHTML = `<a href="${url}" target="_blank" class="fw-bold text-decoration-none">${title || url}</a>`;
                existentesList.appendChild(li);
            });
            existentesSection.style.display = 'block';
        } else {
            existentesSection.style.display = 'none';
        }
    }

    function updateAllMatchedProperties(allMatchedProperties) {
        if (allMatchedProperties) {
            updateNuevasPublications(allMatchedProperties.nuevas || []);
            updateExistentesPublications(allMatchedProperties.existentes || []);
        }
    }

    function showResults(matchedPublications, allMatchedProperties) {
        const progressTitle = document.getElementById('progress-title');
        const progressStatus = document.getElementById('progress-status');
        const resultsList = document.getElementById('results-list');
    // Debug: registrar qué datos llegan y el estado de la flag
    try { console.debug('showResults called', { matchedPublications, allMatchedProperties, currentSearchIsInitialSave }); } catch(e) {}
        
        let totalCount = 0;
        
        // Si tenemos todas las propiedades coincidentes (nuevas + existentes)
        if (allMatchedProperties) {
            const nuevasCount = allMatchedProperties.nuevas ? allMatchedProperties.nuevas.length : 0;
            const existentesCount = allMatchedProperties.existentes ? allMatchedProperties.existentes.length : 0;
            totalCount = nuevasCount + existentesCount;

            progressTitle.textContent = `Resultados encontrados: ${totalCount}`;
            progressStatus.style.display = 'none';

            if (totalCount > 0) {
                if (currentSearchIsInitialSave) {
                    // En la primera ejecución (Buscar y Guardar), no mostrar subtítulos.
                    // Combinar nuevas + existentes en la sección 'nuevas' para mostrar una sola lista.
                    const combined = [];
                    if (Array.isArray(allMatchedProperties.nuevas)) combined.push(...allMatchedProperties.nuevas);
                    if (Array.isArray(allMatchedProperties.existentes)) combined.push(...allMatchedProperties.existentes);
                    updateNuevasPublications(combined);
                    document.getElementById('nuevas-section').style.display = 'block';
                    document.getElementById('existentes-section').style.display = 'none';
                    resultsList.style.display = 'block';
                } else {
                    updateAllMatchedProperties(allMatchedProperties);
                    resultsList.style.display = 'block';
                }
            } else {
                // Mostrar mensaje cuando no hay resultados
                const nuevasList = document.getElementById('nuevas-properties-list');
                nuevasList.innerHTML = '<li class="list-group-item">No se encontraron propiedades con los criterios seleccionados.</li>';
                document.getElementById('nuevas-section').style.display = 'block';
                document.getElementById('existentes-section').style.display = 'none';
                resultsList.style.display = 'block';
            }
        } else {
            // Compatibilidad con el formato anterior
            totalCount = matchedPublications ? matchedPublications.length : 0;
            progressTitle.textContent = `Resultados encontrados: ${totalCount}`;
            progressStatus.style.display = 'none';
            
            if (matchedPublications && matchedPublications.length > 0) {
                updateNuevasPublications(matchedPublications);
                document.getElementById('existentes-section').style.display = 'none';
                resultsList.style.display = 'block';
            } else {
                // Mostrar mensaje cuando no hay resultados
                const nuevasList = document.getElementById('nuevas-properties-list');
                nuevasList.innerHTML = '<li class="list-group-item">No se encontraron propiedades con los criterios seleccionados.</li>';
                document.getElementById('nuevas-section').style.display = 'block';
                document.getElementById('existentes-section').style.display = 'none';
                resultsList.style.display = 'block';
            }
        }
    }

    function resetProgressView() {
        const progressTitle = document.getElementById('progress-title');
        const progressStatus = document.getElementById('progress-status');
        const resultsList = document.getElementById('results-list');
        
        // Restaurar vista de progreso
        progressTitle.textContent = 'Progreso de la búsqueda';
        progressStatus.style.display = 'block';
        resultsList.style.display = 'none';
        document.getElementById('current-search-item').textContent = 'Iniciando...';
        
        // Limpiar las listas de resultados
        document.getElementById('nuevas-section').style.display = 'none';
        document.getElementById('existentes-section').style.display = 'none';
        document.getElementById('nuevas-properties-list').innerHTML = '';
        document.getElementById('existentes-properties-list').innerHTML = '';
    }

    document.addEventListener('DOMContentLoaded', function() {
        mostrarCiudades();
        // Feature flag: habilita/deshabilita la visualización de capturas de debug en la interfaz.
        // Poner a `true` si se quiere volver a activar temporalmente la funcionalidad.
    const ENABLE_DEBUG_SCREENSHOTS_UI = false;
    // La flag currentSearchIsInitialSave ahora es global (arriba) para evitar errores de alcance.
        
        // WebSocket setup PRIMERO
        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const searchProgressSocket = new WebSocket(
            protocol + '//' +
            window.location.host +
            '/ws/search_progress/'
        );
        console.log('🔌 [WebSocket] Conectando a:', protocol + '//' + window.location.host + '/ws/search_progress/');

        const searchProgressDiv = document.getElementById('search-progress');
        const currentSearchItemSpan = document.getElementById('current-search-item');

        searchProgressSocket.onmessage = function(e) {
            const data = JSON.parse(e.data);
            const message = data.message;
            
            // Mostrar debug de IA si está disponible
            if (data.debug_ia) {
                console.log('🤖 [IA DEBUG] Texto original:', data.debug_ia.texto_original);
                console.log('🤖 [IA DEBUG] Filtros extraídos:', data.debug_ia.filtros_extraidos);
                console.log('🤖 [IA DEBUG] Keywords extraídas:', data.debug_ia.keywords_extraidas);
            }
            
            // Mostrar debug de filtros si está disponible
            if (data.debug_filtros) {
                console.log('🎚️ [FILTROS DEBUG] Manuales:', data.debug_filtros.filtros_manuales);
                console.log('🎚️ [FILTROS DEBUG] IA:', data.debug_filtros.filtros_ia);
                console.log('🎚️ [FILTROS DEBUG] Finales:', data.debug_filtros.filtros_finales);
            }

            searchProgressDiv.style.display = 'block'; // Show progress div

            // Manejar tanto objetos como strings en el mensaje
            if (typeof message === 'object') {
                if (message.current_search_item !== undefined && message.current_search_item !== null) {
                    currentSearchItemSpan.textContent = message.current_search_item;
                }
                
                // Mostrar captura de debug si está disponible (solo si la feature flag está habilitada)
                if (ENABLE_DEBUG_SCREENSHOTS_UI && message.debug_screenshot) {
                    console.log('📸 [DEBUG SCREENSHOT] Captura disponible:', message.debug_screenshot);
                    mostrarCapturaDebug(message.debug_screenshot);
                }
                
                // Actualizar lista de publicaciones coincidentes durante la búsqueda
                if (message.matched_publications && Array.isArray(message.matched_publications)) {
                    // Solo log si hay cambios significativos
                    if (message.matched_publications.length > 0 && message.matched_publications.length % 10 === 0) {
                        console.log(`📝 [COINCIDENCIAS] ${message.matched_publications.length} encontradas`);
                    }
                    updateMatchedPublications(message.matched_publications);
                }
                
                if (message.final_message !== undefined && message.final_message !== null) {
                    console.log('🎯 [FINALIZADO]', message.final_message);
                    // Cambiar a vista de resultados usando las propiedades completas si están disponibles
                    if (message.all_matched_properties) {
                        showResults(null, message.all_matched_properties);
                    } else {
                        showResults(message.matched_publications || []);
                    }
                    searchProgressDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    finalizarBusqueda(); // Call finalizarBusqueda when search is done
                }
            } else if (typeof message === 'string') {
                // Manejar mensajes de string simples (para compatibilidad)
                currentSearchItemSpan.textContent = message;
                // Si el mensaje indica finalización, finalizar búsqueda
                if (message.includes('finalizada') || message.includes('detenida') || message.includes('Error')) {
                    showResults([]);
                    searchProgressDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    finalizarBusqueda();
                }
            }
                // Manejar notificaciones de búsquedas guardadas en tiempo real
                if (typeof message === 'object') {
                        // Nota: ahora el servidor crea la búsqueda antes de ejecutar el scraper,
                        // pero solo enviará la notificación 'saved_search_updated' cuando el
                        // scraper termine y tengamos resultados y el título definitivo.
                        // Por compatibilidad, si llega 'saved_search_created' lo ignoramos.
                        if (message.saved_search_updated) {
                            const u = message.saved_search_updated;
                            // Si no existe en la lista, insertarla y remarcar (es nueva)
                            const exists = document.getElementById('search-' + u.id);
                            addOrUpdateSavedSearchInList(u, !exists);
                        }
                }
        };

        searchProgressSocket.onopen = function(e) {
            console.log('✅ [WebSocket] Conectado');
        };

        searchProgressSocket.onclose = function(e) {
            // Solo mostrar si es un cierre inesperado
            if (e.code !== 1000) {
                console.error('❌ [WebSocket] Cerrado inesperadamente:', e.code);
            }
            finalizarBusqueda();
            // Mostrar mensaje de error al usuario
            const searchProgressDiv = document.getElementById('search-progress');
            const currentSearchItemSpan = document.getElementById('current-search-item');
            if (searchProgressDiv.style.display !== 'none') {
                currentSearchItemSpan.textContent = 'Error de conexión. Verifique capturas debug manualmente si es necesario.';
                
                // Mostrar enlace a capturas de debug cuando no hay WebSocket
                setTimeout(() => {
                    mostrarEnlaceDebugFallback();
                }, 3000);
            }
        };

        function mostrarEnlaceDebugFallback() {
            const searchProgressDiv = document.getElementById('search-progress');
            let debugLinkDiv = document.getElementById('debug-fallback-link');

            if (!debugLinkDiv && ENABLE_DEBUG_SCREENSHOTS_UI) {
                debugLinkDiv = document.createElement('div');
                debugLinkDiv.id = 'debug-fallback-link';
                debugLinkDiv.className = 'alert alert-info mt-3';
                debugLinkDiv.innerHTML = `
                    <h5>📸 Modo Sin WebSocket</h5>
                    <p>Para ver capturas de debug (si las hay), visite:</p>
                    <a href="/debug_screenshots/" class="btn btn-outline-primary" target="_blank">
                        Ver Capturas de Debug
                    </a>
                `;
                searchProgressDiv.parentNode.insertBefore(debugLinkDiv, searchProgressDiv.nextSibling);
            }
        }

        searchProgressSocket.onerror = function(e) {
            console.error('🔥 [WebSocket] Error de conexión:', e);
            finalizarBusqueda();
        };
        
        // Configurar formulario DESPUÉS de definir el WebSocket
        var form = document.querySelector('form');
        form.addEventListener('submit', function(e) {
            e.preventDefault(); // Evita la recarga de la página
            iniciarBusqueda();
            
            // Determinar qué botón fue presionado
            const submitter = e.submitter;
            const shouldSave = submitter && submitter.name === 'guardar' && submitter.value === '1';
            
            console.log('🔍 [FRONTEND] Botón presionado:', submitter ? submitter.textContent : 'Desconocido');
            console.log('🔍 [FRONTEND] ¿Guardar búsqueda?', shouldSave);
            
            // Recolectar datos del formulario
            const formData = new FormData(form);
            let texto = '';
            const filtros = {};
            let searchName = '';
            
            for (const [key, value] of formData.entries()) {
                if (key === 'csrfmiddlewaretoken') continue;
                if (key === 'keywords') {
                    texto = value;
                } else if (key === 'name') {
                    searchName = value;
                } else if (key !== 'guardar' && value !== '') {
                    filtros[key] = value;
                }
            }
            
            const payload = {
                texto: texto,
                filtros: filtros,
                guardar: shouldSave,
                name: searchName
            };
            // Marcar si esta ejecución es un "Buscar y Guardar" inicial
            currentSearchIsInitialSave = shouldSave;
            // Enviar por WebSocket
            if (searchProgressSocket.readyState === WebSocket.OPEN) {
                console.log('🚀 [FRONTEND] Enviando búsqueda por WebSocket:', payload);
                searchProgressSocket.send(JSON.stringify(payload));
            } else {
                console.warn('❌ [FRONTEND] WebSocket no está abierto, usando fallback HTTP');
                // Fallback HTTP
                document.getElementById('current-search-item').textContent = 'Iniciando búsqueda por HTTP (WebSockets no disponibles)...';
                
                fetch('/http_search_fallback/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: JSON.stringify(payload)
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        console.log('✅ [HTTP FALLBACK] Búsqueda completada:', data);
                        // Si vino desde "Buscar y Guardar", ya marcamos la flag; mostrar resultados sin subtítulos
                        showResults(data.matched_publications || []);
                    } else {
                        console.error('❌ [HTTP FALLBACK] Error:', data.error);
                        document.getElementById('current-search-item').textContent = `Error: ${data.error}`;
                    }
                    finalizarBusqueda();
                })
                .catch(error => {
                    console.error('❌ [HTTP FALLBACK] Error de red:', error);
                    document.getElementById('current-search-item').textContent = 'Error de conexión';
                    finalizarBusqueda();
                });
            }
        });

        // Función para insertar o actualizar una búsqueda guardada en la lista de la UI
        // Mantiene el mismo HTML que genera el servidor para consistencia visual.
        function addOrUpdateSavedSearchInList(searchObj, highlight=false) {
            if (!searchObj || !searchObj.id) return;
            const list = document.getElementById('busquedas-guardadas');
            let item = document.getElementById('search-' + searchObj.id);
            const titleText = escapeHtml(searchObj.name || searchObj.nombre_busqueda || searchObj.original_text || ('Búsqueda ' + searchObj.id));
            const keywordsText = escapeHtml((searchObj.keywords || []).join(', '));
            const deleteUrl = `/eliminar/${encodeURIComponent(searchObj.id)}/`;

            const htmlContent = `
                <div class="d-flex justify-content-between align-items-center">
                    <a href="#" onclick="expandirBusqueda('${escapeJs(searchObj.id)}'); return false;" class="fw-bold">${titleText}</a>
                    <a href="${deleteUrl}" class="btn btn-sm btn-danger">Eliminar</a>
                </div>
                <div class="busqueda-detalle mt-3 p-0" style="display:none; transition: all 0.3s; border-radius: 0.5rem;"></div>
            `;

            if (item) {
                item.innerHTML = htmlContent;
            } else {
                item = document.createElement('li');
                item.className = 'list-group-item d-flex flex-column';
                item.id = 'search-' + searchObj.id;
                item.innerHTML = htmlContent;
                // Insertar al inicio para visibilidad
                if (list.firstChild) list.insertBefore(item, list.firstChild);
                else list.appendChild(item);
            }

            // Resaltar temporalmente la búsqueda nueva
            if (highlight) {
                item.classList.add('border-warning');
                item.style.backgroundColor = '#fff9e6';
                setTimeout(() => {
                    item.classList.remove('border-warning');
                    item.style.backgroundColor = '';
                }, 7000);
            }
        }

        function escapeHtml(unsafe) {
            return String(unsafe || '').replace(/[&<>"'`]/g, function (m) { return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;","`":"&#96;"})[m]; });
        }

        function escapeJs(s) {
            return String(s).replace(/'/g, "\\'");
        }
    });
    </script>
    
    <!-- Bootstrap JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>