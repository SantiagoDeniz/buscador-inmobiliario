<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Buscador Inmobiliario Inteligente</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    <style>
        .card-img-top { height: 220px; object-fit: cover; }
        .busqueda-detalle .card {
            border-radius: 0.75rem;
            box-shadow: 0 2px 16px rgba(0,0,0,0.08);
            background: linear-gradient(135deg, #f8fafc 0%, #e9ecef 100%);
        }
        .busqueda-detalle h2, .busqueda-detalle h3 {
            font-weight: 700;
            color: #2c3e50;
        }
        .busqueda-detalle ul {
            padding-left: 1.2rem;
        }
        .busqueda-detalle li {
            margin-bottom: 0.5rem;
            font-size: 1.08rem;
        }
        .busqueda-detalle a.btn, .busqueda-detalle button {
            margin-top: 1rem;
        }
        .busqueda-detalle .alert-warning {
            border-radius: 0.5rem;
        }
    </style>
</head>
<body>
    <div class="container my-4">
        <header class="text-center mb-5">
            <h1>Buscador de Propiedades</h1>
            <p class="lead">Encuentra la propiedad perfecta analizando miles de publicaciones por ti.</p>
        </header>

        <div class="card p-4 shadow-sm mb-5" id="search-form">
            <form method="post" action="" autocomplete="off">
                {% csrf_token %}
                <div class="row g-3 mb-2">
                    <div class="col-md-12">
                        <label for="keywords" class="form-label fw-bold">¿Qué estás buscando?</label>
                        {% if search_data %}
                        <input type="text" name="keywords" id="keywords" class="form-control form-control-lg" placeholder="Ej: parrillero, luminoso, cerca de la rambla..." value="{{ search_data.keywords|join:', ' }}">
                        {% else %}
                        <input type="text" name="keywords" id="keywords" class="form-control form-control-lg" placeholder="Ej: parrillero, luminoso, cerca de la rambla...">
                        {% endif %}
                    </div>
                </div>
                <div class="row g-3 mb-2">
                    <div class="col-md-3">
                        <label for="departamento" class="form-label">Departamento</label>
                        <select name="departamento" id="departamento" class="form-select" onchange="mostrarCiudades()">
                            <option>Montevideo</option>
                            <option value="">Todos</option>
                            <option>Artigas</option>
                            <option>Canelones</option>
                            <option>Cerro Largo</option>
                            <option>Colonia</option>
                            <option>Durazno</option>
                            <option>Flores</option>
                            <option>Florida</option>
                            <option>Lavalleja</option>
                            <option>Maldonado</option>
                            <option>Paysandú</option>
                            <option>Rivera</option>
                            <option>Rocha</option>
                            <option>Río Negro</option>
                            <option>Salto</option>
                            <option>San José</option>
                            <option>Soriano</option>
                            <option>Tacuarembó</option>
                            <option>Treinta y Tres</option>
                        </select>
                    </div>
                    <div class="col-md-3" id="ciudad_div" style="display:none">
                        <label for="ciudad" class="form-label">Ciudad (solo Montevideo)</label>
                        <select name="ciudad" id="ciudad" class="form-select">
                            <option value="">Todas</option>
                            <option>Aguada</option>
                            <option>Aires Puros</option>
                            <option>Arroyo Seco</option>
                            <option>Atahualpa</option>
                            <option>Barrio Sur</option>
                            <option>Bella Vista</option>
                            <option>Belvedere</option>
                            <option>Bolivar</option>
                            <option>Brazo Oriental</option>
                            <option>Buceo</option>
                            <option>Capurro</option>
                            <option>Carrasco</option>
                            <option>Carrasco Norte</option>
                            <option>Casavalle</option>
                            <option>Centro</option>
                            <option>Cerrito</option>
                            <option>Cerro</option>
                            <option>Ciudad Vieja</option>
                            <option>Colón</option>
                            <option>Cordón</option>
                            <option>Flor de Maroñas</option>
                            <option>Goes</option>
                            <option>Ituzaingó</option>
                            <option>Jacinto Vera</option>
                            <option>Jardines Hipódromo</option>
                            <option>La Blanqueada</option>
                            <option>La Comercial</option>
                            <option>La Figurita</option>
                            <option>La Teja</option>
                            <option>Larrañaga</option>
                            <option>Las Acacias</option>
                            <option>Lezica</option>
                            <option>Malvin</option>
                            <option>Malvin Norte</option>
                            <option>Manga</option>
                            <option>Marconi</option>
                            <option>Maroñas</option>
                            <option>Maroñas, Curva</option>
                            <option>Melilla</option>
                            <option>Mercado Modelo</option>
                            <option>Montevideo</option>
                            <option>Nuevo París</option>
                            <option>Palermo</option>
                            <option>Parque Batlle</option>
                            <option>Parque Rodó</option>
                            <option>Paso de la Arena</option>
                            <option>Paso Molino</option>
                            <option>Peñarol</option>
                            <option>Perez Castellanos</option>
                            <option>Piedras Blancas</option>
                            <option>Pocitos</option>
                            <option>Pocitos Nuevo</option>
                            <option>Prado</option>
                            <option>Puerto Buceo</option>
                            <option>Punta Carretas</option>
                            <option>Punta Gorda</option>
                            <option>Punta Rieles</option>
                            <option>Reducto</option>
                            <option>Santiago Vázquez</option>
                            <option>Sayago</option>
                            <option>Tres Cruces</option>
                            <option>Unión</option>
                            <option>Villa Biarritz</option>
                            <option>Villa Dolores</option>
                            <option>Villa Española</option>
                            <option>Villa Muñoz</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="operacion" class="form-label">Tipo de operación</label>
                        <select name="operacion" id="operacion" class="form-select">
                            <option value="">Todas</option>
                            <option>Venta</option>
                            <option>Alquiler</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="tipo" class="form-label">Tipo de inmueble</label>
                        <select name="tipo" id="tipo" class="form-select">
                            <option value="">Todos</option>
                            <option>Apartamentos</option>
                            <option>Campos</option>
                            <option>Casas</option>
                            <option>Cocheras</option>
                            <option>Depósitos y galpones</option>
                            <option>Llave de negocio</option>
                            <option>Locales</option>
                            <option>Oficinas</option>
                            <option>Quintas</option>
                            <option>Terrenos</option>
                            <option>Otros inmuebles</option>
                        </select>
                    </div>
                </div>
                <div class="row g-3 mb-2">
                    <div class="col-md-3">
                        <label for="moneda" class="form-label">Moneda</label>
                        <select name="moneda" id="moneda" class="form-select">
                            <option value="USD" {% if search_data.filters.moneda == 'USD' or not search_data.filters.moneda %}selected{% endif %}>USD</option>
                            <option value="UYU" {% if search_data.filters.moneda == 'UYU' %}selected{% endif %}>UYU</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="precio_min" class="form-label">Precio mínimo</label>
                        <input type="number" min="0" name="precio_min" id="precio_min" class="form-control" placeholder="Ej: 50000" value="{{ search_data.filters.precio_min|default:'' }}">
                    </div>
                    <div class="col-md-3">
                        <label for="precio_max" class="form-label">Precio máximo</label>
                        <input type="number" min="0" name="precio_max" id="precio_max" class="form-control" placeholder="Ej: 200000" value="{{ search_data.filters.precio_max|default:'' }}">
                    </div>
                    <div class="col-md-3">
                        <label for="name" class="form-label">Título para la búsqueda:</label>
                        {% if search_data %}
                        <input type="text" name="name" id="name" class="form-control" value="{{ search_data.name }}">
                        {% else %}
                        <input type="text" name="name" id="name" class="form-control">
                        {% endif %}
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-12 text-center">
                        <div id="botones-busqueda">
                            <button type="submit" class="btn btn-primary mx-2">Buscar</button>
                            <button type="submit" name="guardar" value="1" class="btn btn-success mx-2">Buscar y Guardar</button>
                        </div>
                        <div id="boton-detener" style="display:none;">
                            <button type="button" class="btn btn-warning mx-2" onclick="detenerBusqueda()">Detener búsqueda</button>
                        </div>
                    </div>
                </div>
            </form>
        </div>

        {% if results is not None %}
        <div id="resultados">
            <h2 class="mb-4">Resultados encontrados: {{ results|length }}</h2>
            <ul class="list-group mb-4">
                {% for r in results %}
                    <li class="list-group-item animate__animated animate__fadeInUp">
                        <a href="{{ r.url }}" target="_blank" class="fw-bold text-decoration-none">{{ r.titulo|default:r.url }}</a>
                    </li>
                {% empty %}
                    <li class="list-group-item animate__animated animate__fadeInUp">No se encontraron propiedades con los criterios seleccionados.</li>
                {% endfor %}
            </ul>
        </div>
        {% endif %}

        <div class="mt-5">
            <h3>Búsquedas guardadas</h3>
            <ul class="list-group" id="busquedas-guardadas">
                {% for search in searches %}
                    <li class="list-group-item d-flex flex-column" id="search-{{ search.id }}">
                        <div class="d-flex justify-content-between align-items-center">
                            <a href="#" onclick="expandirBusqueda('{{ search.id }}'); return false;" class="fw-bold">{{ search.nombre }}</a>
                            <a href="{% url 'core:delete_search' search.id %}" class="btn btn-sm btn-danger">Eliminar</a>
                        </div>
                        <div class="busqueda-detalle mt-3 p-0" style="display:none; transition: all 0.3s; border-radius: 0.5rem;"></div>
                    </li>
                {% empty %}
                    <li class="list-group-item">No hay búsquedas guardadas.</li>
                {% endfor %}
            </ul>
        </div>
    </div>
    <script>
    function expandirBusqueda(searchId) {
        var detalleDiv = document.querySelector('#search-' + searchId + ' .busqueda-detalle');
        if (detalleDiv.style.display === 'none') {
            fetch('/ajax/busqueda/' + searchId + '/')
                .then(response => response.json())
                .then(data => {
                    detalleDiv.innerHTML = `<div class='card shadow-sm border-0 bg-light p-4 mb-3 animate__animated animate__fadeIn'>${data.html}</div>`;
                    detalleDiv.style.display = 'block';
                    // Scroll suave al elemento expandido
                    setTimeout(function() {
                        detalleDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }, 200);
                });
        } else {
            detalleDiv.innerHTML = '';
            detalleDiv.style.display = 'none';
        }
    }
        function mostrarCiudades() {
            var dep = document.getElementById('departamento').value;
            document.getElementById('ciudad_div').style.display = (dep === 'Montevideo') ? '' : 'none';
        }

        // Lógica para mostrar/ocultar botones
        let buscando = false;
        function iniciarBusqueda() {
                buscando = true;
                document.getElementById('botones-busqueda').style.display = 'none';
                document.getElementById('boton-detener').style.display = 'block';
        }
        function finalizarBusqueda() {
                buscando = false;
                document.getElementById('botones-busqueda').style.display = 'block';
                document.getElementById('boton-detener').style.display = 'none';
        }
        function detenerBusqueda() {
                // Lógica AJAX para detener búsqueda en backend
                fetch('/detener-busqueda/', {method: 'POST', headers: {'X-CSRFToken': '{{ csrf_token }}'}})
                        .then(() => {
                                finalizarBusqueda();
                        });
        }

        // Mostrar ciudad si ya estaba seleccionada Montevideo y lógica de botones
        document.addEventListener('DOMContentLoaded', function() {
            mostrarCiudades();
            var form = document.querySelector('form');
            form.addEventListener('submit', function(e) {
                iniciarBusqueda();
            });
        });
    </script>
</body>
</html>