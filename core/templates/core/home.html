<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Buscador Inmobiliario Inteligente</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style> .card-img-top { height: 220px; object-fit: cover; } </style>
</head>
<body>
    <div class="container my-4">
        <header class="text-center mb-5">
            <h1>Buscador de Propiedades</h1>
            <p class="lead">Encuentra la propiedad perfecta analizando miles de publicaciones por ti.</p>
        </header>

        <div class="card p-4 shadow-sm mb-5" id="search-form">
            <form method="post" action="" autocomplete="off">
                {% csrf_token %}
                <div class="row g-3">
                    <div class="col-12">
                        <label for="keywords" class="form-label fw-bold">¿Qué estás buscando?</label>
                        {% if search_data %}
                        <input type="text" name="keywords" id="keywords" class="form-control form-control-lg" placeholder="Ej: parrillero, luminoso, cerca de la rambla..." value="{{ search_data.keywords|join:', ' }}">
                        {% else %}
                        <input type="text" name="keywords" id="keywords" class="form-control form-control-lg" placeholder="Ej: parrillero, luminoso, cerca de la rambla...">
                        {% endif %}
                    </div>
                    <div class="col-md-4 col-lg-2">
                        <label for="precio_min" class="form-label">Precio mínimo</label>
                        <input type="number" min="0" name="precio_min" id="precio_min" class="form-control" placeholder="Ej: 50000" value="{{ search_data.filters.precio_min|default:'' }}">
                    </div>
                    <div class="col-md-4 col-lg-2">
                        <label for="precio_max" class="form-label">Precio máximo</label>
                        <input type="number" min="0" name="precio_max" id="precio_max" class="form-control" placeholder="Ej: 200000" value="{{ search_data.filters.precio_max|default:'' }}">
                    </div>
                    <div class="col-md-4 col-lg-2">
                        <label for="moneda" class="form-label">Moneda</label>
                        <select name="moneda" id="moneda" class="form-select">
                            <option value="USD" {% if search_data.filters.moneda == 'USD' or not search_data.filters.moneda %}selected{% endif %}>USD</option>
                            <option value="UYU" {% if search_data.filters.moneda == 'UYU' %}selected{% endif %}>UYU</option>
                        </select>
                    </div>
                    <div class="col-md-6 col-lg-3">
                        <label for="departamento" class="form-label">Departamento</label>
                        <select name="departamento" id="departamento" class="form-select" onchange="mostrarCiudades()">
                            <option value="">Todos</option>
                            <option>Artigas</option>
                            <option>Canelones</option>
                            <option>Cerro Largo</option>
                            <option>Colonia</option>
                            <option>Durazno</option>
                            <option>Flores</option>
                            <option>Florida</option>
                            <option>Lavalleja</option>
                            <option>Maldonado</option>
                            <option>Montevideo</option>
                            <option>Paysandú</option>
                            <option>Rivera</option>
                            <option>Rocha</option>
                            <option>Río Negro</option>
                            <option>Salto</option>
                            <option>San José</option>
                            <option>Soriano</option>
                            <option>Tacuarembó</option>
                            <option>Treinta y Tres</option>
                        </select>
                    </div>
                    <div class="col-md-6 col-lg-3" id="ciudad_div" style="display:none">
                        <label for="ciudad" class="form-label">Ciudad (solo Montevideo)</label>
                        <select name="ciudad" id="ciudad" class="form-select">
                            <option value="">Todas</option>
                            <option>Aguada</option>
                            <option>Aires Puros</option>
                            <option>Arroyo Seco</option>
                            <option>Atahualpa</option>
                            <option>Barrio Sur</option>
                            <option>Bella Vista</option>
                            <option>Belvedere</option>
                            <option>Bolivar</option>
                            <option>Brazo Oriental</option>
                            <option>Buceo</option>
                            <option>Capurro</option>
                            <option>Carrasco</option>
                            <option>Carrasco Norte</option>
                            <option>Casavalle</option>
                            <option>Centro</option>
                            <option>Cerrito</option>
                            <option>Cerro</option>
                            <option>Ciudad Vieja</option>
                            <option>Colón</option>
                            <option>Cordón</option>
                            <option>Flor de Maroñas</option>
                            <option>Goes</option>
                            <option>Ituzaingó</option>
                            <option>Jacinto Vera</option>
                            <option>Jardines Hipódromo</option>
                            <option>La Blanqueada</option>
                            <option>La Comercial</option>
                            <option>La Figurita</option>
                            <option>La Teja</option>
                            <option>Larrañaga</option>
                            <option>Las Acacias</option>
                            <option>Lezica</option>
                            <option>Malvin</option>
                            <option>Malvin Norte</option>
                            <option>Manga</option>
                            <option>Marconi</option>
                            <option>Maroñas</option>
                            <option>Maroñas, Curva</option>
                            <option>Melilla</option>
                            <option>Mercado Modelo</option>
                            <option>Montevideo</option>
                            <option>Nuevo París</option>
                            <option>Palermo</option>
                            <option>Parque Batlle</option>
                            <option>Parque Rodó</option>
                            <option>Paso de la Arena</option>
                            <option>Paso Molino</option>
                            <option>Peñarol</option>
                            <option>Perez Castellanos</option>
                            <option>Piedras Blancas</option>
                            <option>Pocitos</option>
                            <option>Pocitos Nuevo</option>
                            <option>Prado</option>
                            <option>Puerto Buceo</option>
                            <option>Punta Carretas</option>
                            <option>Punta Gorda</option>
                            <option>Punta Rieles</option>
                            <option>Reducto</option>
                            <option>Santiago Vázquez</option>
                            <option>Sayago</option>
                            <option>Tres Cruces</option>
                            <option>Unión</option>
                            <option>Villa Biarritz</option>
                            <option>Villa Dolores</option>
                            <option>Villa Española</option>
                            <option>Villa Muñoz</option>
                        </select>
                    </div>
                    <div class="col-md-6 col-lg-3">
                        <label for="operacion" class="form-label">Tipo de operación</label>
                        <select name="operacion" id="operacion" class="form-select">
                            <option value="">Todas</option>
                            <option>Venta</option>
                            <option>Alquiler</option>
                        </select>
                    </div>
                    <div class="col-md-6 col-lg-3">
                        <label for="tipo" class="form-label">Tipo de inmueble</label>
                        <select name="tipo" id="tipo" class="form-select">
                            <option value="">Todos</option>
                            <option>Apartamentos</option>
                            <option>Campos</option>
                            <option>Casas</option>
                            <option>Cocheras</option>
                            <option>Depósitos y galpones</option>
                            <option>Llave de negocio</option>
                            <option>Locales</option>
                            <option>Oficinas</option>
                            <option>Quintas</option>
                            <option>Terrenos</option>
                            <option>Otros inmuebles</option>
                        </select>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-12 col-md-8">
                        <label for="name" class="form-label">Título para guardar esta búsqueda (opcional):</label>
                        {% if search_data %}
                        <input type="text" name="name" id="name" class="form-control" value="{{ search_data.name }}">
                        {% else %}
                        <input type="text" name="name" id="name" class="form-control">
                        {% endif %}
                    </div>
                    <div class="col-12 col-md-4 d-flex align-items-end">
                        <button type="submit" class="btn btn-primary w-100 me-2">Buscar</button>
                        <button type="submit" name="guardar" value="1" class="btn btn-success w-100">Buscar y Guardar</button>
                    </div>
                </div>
            </form>
        </div>

        {% if results is not None %}
        <div id="resultados">
            <h2 class="mb-4">Resultados encontrados: {{ results|length }}</h2>
            <div class="row row-cols-1 row-cols-md-2 row-cols-lg-4 g-4">
                {% for r in results %}
                    <div class="col">
                        <div class="card h-100 shadow-sm">
                            <a href="{{ r.url }}" target="_blank" class="text-decoration-none text-dark">
                                <div class="card-body">
                                    <h5 class="card-title">{{ r.url }}</h5>
                                </div>
                            </a>
                        </div>
                    </div>
                {% empty %}
                    <div class="col-12">
                        <div class="alert alert-info" role="alert">
                            No se encontraron propiedades con los criterios seleccionados.
                        </div>
                    </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <div class="mt-5">
            <h3>Búsquedas guardadas</h3>
            <ul class="list-group">
                {% for search in searches %}
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <a href="{% url 'core:search_detail' search.id %}">{{ search.name }}</a>
                        <a href="{% url 'core:delete_search' search.id %}" class="btn btn-sm btn-danger">Eliminar</a>
                    </li>
                {% empty %}
                    <li class="list-group-item">No hay búsquedas guardadas.</li>
                {% endfor %}
            </ul>
        </div>
    </div>
    <script>
    function mostrarCiudades() {
      var dep = document.getElementById('departamento').value;
      document.getElementById('ciudad_div').style.display = (dep === 'Montevideo') ? '' : 'none';
    }
    // Mostrar ciudad si ya estaba seleccionada Montevideo
    document.addEventListener('DOMContentLoaded', function() {
      mostrarCiudades();
    });
    </script>
</body>
</html>